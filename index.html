<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>接案收入帳本</title>

    <!-- App 圖示設定 -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f4f4f6">

    <!-- 引入圖表庫 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #f4f4f6;     
            --card-bg: #ffffff;      
            --text-main: #333333;    
            --text-light: #8e8e93;   
            --accent: #636366;       
            --border: #e5e5ea;       
            --status-unbilled: #aeaeb2; 
            --status-pending: #7986cb;  
            --status-paid: #34c759;     
            --delete-color: #ff3b30; 
            --nav-height: 60px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            /* 修正：預留更多底部空間，防止內容被變高的導航列擋住 */
            padding-bottom: calc(var(--nav-height) + 60px); 
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 600px; margin: 0 auto; }
        
        /* 隱藏頁面機制 */
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { font-weight: 300; text-align: center; color: var(--accent); margin-bottom: 20px; }
        h1 { font-size: 1.4rem; letter-spacing: 2px; }

        /* --- 底部導航列 (已修正安全區域) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            /* 修正：自動高度，適應不同手機的下巴 */
            height: auto; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
            
            /* 修正：上下內距 + 自動避開黑條 (env) */
            padding-top: 12px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
        
        .nav-item {
            flex: 1; text-align: center; cursor: pointer;
            color: var(--text-light); font-size: 0.7rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; fill: currentColor; }
        .nav-item.active { color: var(--text-main); font-weight: 600; }

        /* --- 共用卡片樣式 --- */
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }

        /* --- 記帳頁 (Ledger) --- */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        select { background: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 8px; flex: 1; font-size: 0.9rem; }
        
        /* 浮動按鈕位置也需要微調，避開變高的導航列 */
        .add-btn-float {
            position: fixed; 
            bottom: calc(var(--nav-height) + 40px + env(safe-area-inset-bottom)); 
            right: 20px;
            background: var(--text-main); color: white; width: 56px; height: 56px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 900;
            border: none;
        }
        .add-btn-float:active { transform: scale(0.95); }

        /* 列表樣式 */
        .record-list { list-style: none; padding: 0; }
        .record-card {
            background: var(--card-bg); padding: 16px; margin-bottom: 12px;
            border-radius: 10px; border-left: 5px solid var(--status-unbilled);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .record-card.status-未請款 { border-left-color: var(--status-unbilled); }
        .record-card.status-已請款 { border-left-color: var(--status-pending); }
        .record-card.status-已入帳 { border-left-color: var(--status-paid); }
        
        .card-row { display: flex; justify-content: space-between; align-items: baseline; }
        .card-date { font-size: 0.8rem; color: var(--text-light); }
        .card-amt { font-size: 1.1rem; font-weight: bold; }
        .card-client { font-size: 0.95rem; font-weight: 600; color: #555; }
        .card-project { font-size: 0.85rem; color: #777; margin-bottom: 8px; }
        .btn-mini { border: 1px solid var(--border); background: none; padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; color: var(--text-light); cursor: pointer; }
        .status-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: #eee; color: #666; }

        /* --- 統計頁 (Stats) --- */
        .goal-section { text-align: center; margin-bottom: 20px; }
        .progress-container { background: #eee; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--status-paid); width: 0%; transition: width 0.5s; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .stat-box h4 { margin: 0; font-size: 0.8rem; color: var(--text-light); font-weight: normal; }
        .stat-box p { margin: 5px 0 0; font-size: 1.1rem; font-weight: bold; }

        /* --- 設定頁 (Settings) --- */
        .settings-list { list-style: none; padding: 0; }
        .settings-list li {
            background: var(--card-bg); padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .settings-list li:first-child { border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .settings-list li:last-child { border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border-bottom: none; }
        .btn-logout { width: 100%; padding: 15px; background: #fff; border: 1px solid var(--delete-color); color: var(--delete-color); border-radius: 10px; margin-top: 20px; font-size: 1rem; }

        /* --- 表單 & 登入遮罩 --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal { background: #fff; padding: 25px; width: 85%; max-width: 350px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal input, .modal select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
        .modal-btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-primary { background: var(--text-main); color: #fff; border: none; padding: 10px; border-radius: 6px; flex: 1; font-size: 1rem; }
        .btn-secondary { background: #eee; color: #333; border: none; padding: 10px; border-radius: 6px; flex: 1; font-size: 1rem; }
        
        .hidden { display: none !important; }

    </style>
</head>
<body>

<!-- 1. 登入遮罩 -->
<div id="login-overlay" class="overlay">
    <div class="modal">
        <h2 style="margin-top:0;">歡迎回來</h2>
        <p style="text-align:center; color:#888; font-size:0.9rem;">請輸入您的密碼</p>
        <input type="password" id="password-input" placeholder="Password" style="text-align:center;">
        <button class="btn-primary" onclick="checkLogin()" style="width:100%">進入帳本</button>
        <p id="login-msg" style="color:red; font-size:0.8rem; text-align:center; margin-top:10px;"></p>
    </div>
</div>

<!-- 2. 新增/編輯 表單 (預設隱藏) -->
<div id="form-overlay" class="overlay hidden">
    <div class="modal">
        <h3 id="form-title" style="text-align:center; margin-top:0;">記一筆</h3>
        
        <label style="font-size:0.8rem; color:#888;">日期</label>
        <input type="date" id="in-date">
        
        <input list="client-list" id="in-client" placeholder="客戶名稱">
        <datalist id="client-list"></datalist>

        <input type="text" id="in-project" placeholder="專案名稱">
        <input type="number" id="in-amount" placeholder="金額" inputmode="numeric">
        
        <select id="in-status">
            <option value="未請款">未請款</option>
            <option value="已請款">已請款 (等待中)</option>
            <option value="已入帳">已入帳</option>
        </select>

        <div class="modal-btn-row">
            <button class="btn-primary" id="save-btn" onclick="submitData()">儲存</button>
            <button class="btn-secondary" onclick="closeForm()">取消</button>
        </div>
    </div>
</div>

<!-- 3. 目標設定表單 (預設隱藏) -->
<div id="goal-overlay" class="overlay hidden">
    <div class="modal">
        <h3 style="text-align:center;">設定月目標</h3>
        <input type="number" id="goal-input" placeholder="例如: 50000" inputmode="numeric">
        <div class="modal-btn-row">
            <button class="btn-primary" onclick="saveGoal()">設定</button>
            <button class="btn-secondary" onclick="document.getElementById('goal-overlay').classList.add('hidden')">取消</button>
        </div>
    </div>
</div>

<div class="container">
    
    <!-- ================= 頁面 1: 帳本 (Home) ================= -->
    <section id="page-ledger" class="page-section active">
        <h1>FREELANCE LOG</h1>
        
        <div class="controls">
            <select id="filter-year" onchange="applyFilter()"><option value="all">所有年份</option></select>
            <select id="filter-month" onchange="applyFilter()"><option value="all">所有月份</option></select>
            <select id="filter-client" onchange="applyFilter()"><option value="all">所有客戶</option></select>
        </div>

        <div id="loader" style="text-align:center; padding:20px; color:#888;">正在讀取雲端資料...</div>
        <ul id="record-list" class="record-list"></ul>

        <!-- 浮動新增按鈕 -->
        <button class="add-btn-float" onclick="openAddMode()">+</button>
    </section>

    <!-- ================= 頁面 2: 統計 (Stats) ================= -->
    <section id="page-stats" class="page-section">
        <h2>財務儀表板</h2>

        <!-- 目標進度卡片 -->
        <div class="card goal-section" onclick="openGoalSettings()">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.9rem; color:#888;">本月目標進度</span>
                <span id="goal-text" style="font-size:0.8rem; color:var(--accent);">設定目標 ></span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:5px;">
                <span id="current-month-income" style="font-size:1.5rem; font-weight:bold;">$0</span>
                <span id="goal-target" style="font-size:0.9rem; color:#888;">/ $0</span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="goal-bar"></div>
            </div>
            <p id="goal-percent" style="margin:0; font-size:0.8rem; text-align:right;">0%</p>
        </div>

        <!-- 數據概覽 -->
        <div class="stat-grid">
            <div class="stat-box">
                <h4>總收入 (預估)</h4>
                <p id="stat-total-est">$0</p>
            </div>
            <div class="stat-box">
                <h4>實際入袋</h4>
                <p id="stat-total-real" style="color:var(--status-paid);">$0</p>
            </div>
        </div>

        <!-- 圖表區 -->
        <div class="card">
            <h4 style="margin-top:0; color:#888; font-weight:normal;">每月收入趨勢 (今年)</h4>
            <canvas id="chart-bar"></canvas>
        </div>

        <div class="card">
            <h4 style="margin-top:0; color:#888; font-weight:normal;">客戶貢獻佔比 (Top 5)</h4>
            <canvas id="chart-pie" style="max-height:250px;"></canvas>
        </div>
    </section>

    <!-- ================= 頁面 3: 設定 (Settings) ================= -->
    <section id="page-settings" class="page-section">
        <h2>設定</h2>
        
        <ul class="settings-list">
            <li>
                <span>目前版本</span>
                <span style="color:#888;">v2.1</span>
            </li>
            <li onclick="openGoalSettings()" style="cursor:pointer;">
                <span>修改月收入目標</span>
                <span>></span>
            </li>
            <li onclick="window.open('https://docs.google.com/spreadsheets', '_blank')" style="cursor:pointer;">
                <span>開啟 Google 試算表</span>
                <span>></span>
            </li>
        </ul>

        <button class="btn-logout" onclick="logout()">登出帳號</button>
        <p style="text-align:center; margin-top:20px; color:#ccc; font-size:0.8rem;">
            Created for Freelancers
        </p>
    </section>

</div>

<!-- 底部導航列 -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('ledger', this)">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
        <span>帳本</span>
    </div>
    <div class="nav-item" onclick="switchPage('stats', this)">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
        <span>分析</span>
    </div>
    <div class="nav-item" onclick="switchPage('settings', this)">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        <span>設定</span>
    </div>
</nav>

<script>
    // ==========================================
    // ⚠️ 請在此填入你的 GAS 網址 (請保留引號)
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwsWP7prYO9nOLx3k25qy5OBXYXHyTeP02cOAWxdU1dlRBz_a-sEwnwUEDLws-6t0rimg/exec'; 
    // ==========================================

    let rawData = [];
    let currentEditId = null; 
    let USER_TOKEN = '';
    let monthlyGoal = localStorage.getItem('freelance_goal') || 50000; 

    // 圖表實例
    let chartBarInstance = null;
    let chartPieInstance = null;

    window.onload = function() {
        // 1. 檢查密碼
        const savedPass = localStorage.getItem('freelance_app_password');
        if(savedPass) {
            USER_TOKEN = savedPass;
            document.getElementById('login-overlay').classList.add('hidden');
            fetchData();
        }
        // 2. 初始化日期
        setDefaultDate();
        // 3. 初始化目標顯示
        updateGoalUI();
    };

    // --- 頁面切換邏輯 ---
    function switchPage(pageName, navEl) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(navEl) navEl.classList.add('active');

        if(pageName === 'stats') {
            renderCharts();
        }
    }

    // --- 登入與資料讀取 ---
    function checkLogin() {
        const input = document.getElementById('password-input').value;
        if(!input) return;
        USER_TOKEN = input;
        const msg = document.getElementById('login-msg');
        msg.innerText = "驗證中...";
        
        fetch(GOOGLE_SCRIPT_URL + '?action=get&password=' + encodeURIComponent(USER_TOKEN))
        .then(res => res.json())
        .then(json => {
            if(json.status === 'success') {
                localStorage.setItem('freelance_app_password', USER_TOKEN);
                document.getElementById('login-overlay').classList.add('hidden');
                processData(json);
            } else {
                msg.innerText = "密碼錯誤";
                USER_TOKEN = '';
            }
        })
        .catch(err => msg.innerText = "連線失敗");
    }

    function fetchData() {
        document.getElementById('loader').classList.remove('hidden');
        fetch(GOOGLE_SCRIPT_URL + '?action=get&password=' + encodeURIComponent(USER_TOKEN))
        .then(res => res.json())
        .then(json => {
            if(json.status === 'success') processData(json);
            else if(json.message.includes('密碼')) logout(); 
        })
        .catch(err => console.error(err));
    }

    function processData(json) {
        rawData = json.data;
        updateClientDatalist(json.clients);
        populateDateFilters();
        applyFilter(); 
        document.getElementById('loader').classList.add('hidden');
    }

    // --- 核心資料操作 ---
    function submitData() {
        const date = document.getElementById('in-date').value;
        const client = document.getElementById('in-client').value;
        const project = document.getElementById('in-project').value;
        const amount = document.getElementById('in-amount').value;
        const status = document.getElementById('in-status').value;

        if(!date || !client || !amount) { alert("請填寫完整資訊"); return; }

        const payload = { date, client, project, amount, status, password: USER_TOKEN };
        const btn = document.getElementById('save-btn');
        const orgText = btn.innerText;
        btn.innerText = "處理中..."; btn.disabled = true;

        let action = currentEditId ? 'edit' : 'add';
        if(currentEditId) payload.id = currentEditId;

        fetch(GOOGLE_SCRIPT_URL + '?action=' + action, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.json())
        .then(res => {
            if(res.status === 'success') {
                closeForm();
                fetchData();
            } else alert(res.message);
        })
        .finally(() => { btn.innerText = orgText; btn.disabled = false; });
    }

    function updateStatus(rowIndex, newStatus) {
        const item = rawData.find(r => r.rowIndex === rowIndex);
        if(item) item.status = newStatus;
        applyFilter(); 
        fetch(GOOGLE_SCRIPT_URL + '?action=updateStatus', {
            method: 'POST', body: JSON.stringify({ rowIndex, newStatus, password: USER_TOKEN })
        });
    }

    function deleteRecord(id) {
        if(!confirm("確定刪除？")) return;
        fetch(GOOGLE_SCRIPT_URL + '?action=delete', {
            method: 'POST', body: JSON.stringify({ id, password: USER_TOKEN })
        }).then(res => res.json()).then(res => {
            if(res.status === 'success') fetchData();
        });
    }

    // --- 介面渲染 ---
    function applyFilter() {
        const year = document.getElementById('filter-year').value;
        const month = document.getElementById('filter-month').value;
        const client = document.getElementById('filter-client').value;
        
        const filtered = rawData.filter(item => {
            const d = new Date(item.date);
            return (year === 'all' || d.getFullYear().toString() === year) &&
                   (month === 'all' || (d.getMonth() + 1).toString() === month) &&
                   (client === 'all' || item.client === client);
        });
        
        renderList(filtered);
    }

    function renderList(data) {
        const list = document.getElementById('record-list');
        list.innerHTML = '';
        if(data.length === 0) {
            list.innerHTML = '<li style="text-align:center;color:#ccc;margin-top:20px;">無資料</li>';
            return;
        }

        data.forEach(item => {
            const amt = parseInt(item.amount) || 0;
            let dateStr = item.date.substring(0, 10);
            const li = document.createElement('li');
            const statusClass = item.status.split('(')[0];
            
            li.className = `record-card status-${statusClass}`;
            li.innerHTML = `
                <div class="card-row" onclick="openEditMode('${item.id}')">
                    <div>
                        <div class="card-client">${item.client}</div>
                        <div class="card-project">${item.project}</div>
                        <span class="card-date">${dateStr}</span>
                        <span class="status-badge">${item.status}</span>
                    </div>
                    <div style="text-align:right;">
                        <div class="card-amt">$${amt.toLocaleString()}</div>
                        <div style="margin-top:10px;">
                            <button class="btn-mini" onclick="event.stopPropagation(); deleteRecord('${item.id}')">刪除</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px; display:flex; align-items:center;">
                   <span style="font-size:0.75rem; color:#888; margin-right:5px;">快速切換:</span>
                   <select style="padding:5px; font-size:0.8rem;" onchange="updateStatus(${item.rowIndex}, this.value)">
                        <option value="未請款" ${item.status === '未請款' ? 'selected' : ''}>未請款</option>
                        <option value="已請款" ${item.status === '已請款' ? 'selected' : ''}>已請款</option>
                        <option value="已入帳" ${item.status === '已入帳' ? 'selected' : ''}>已入帳</option>
                   </select>
                </div>
            `;
            list.appendChild(li);
        });
    }

    // --- 統計圖表 ---
    function renderCharts() {
        if(rawData.length === 0) return;

        let totalEst = 0, totalReal = 0;
        let monthlyData = {}; 
        let clientData = {};  
        const currentYear = new Date().getFullYear();
        let currentMonthIncome = 0;
        const now = new Date();
        const thisMonthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

        rawData.forEach(item => {
            const d = new Date(item.date);
            const amt = parseInt(item.amount) || 0;
            const y = d.getFullYear();
            const m = d.getMonth() + 1;
            const key = `${y}-${String(m).padStart(2,'0')}`;

            totalEst += amt;
            if(item.status === '已入帳') totalReal += amt;

            if(y === currentYear) {
                if(!monthlyData[m]) monthlyData[m] = 0;
                monthlyData[m] += amt;
            }
            if(!clientData[item.client]) clientData[item.client] = 0;
            clientData[item.client] += amt;

            if(key === thisMonthKey) currentMonthIncome += amt;
        });

        document.getElementById('stat-total-est').innerText = '$' + totalEst.toLocaleString();
        document.getElementById('stat-total-real').innerText = '$' + totalReal.toLocaleString();
        updateGoalProgress(currentMonthIncome);

        const ctxBar = document.getElementById('chart-bar').getContext('2d');
        if(chartBarInstance) chartBarInstance.destroy(); 
        const labelsBar = []; const dataBar = [];
        for(let i=1; i<=12; i++) { labelsBar.push(i + '月'); dataBar.push(monthlyData[i] || 0); }
        chartBarInstance = new Chart(ctxBar, { type: 'bar', data: { labels: labelsBar, datasets: [{ label: '月收入', data: dataBar, backgroundColor: '#7986cb', borderRadius: 4 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });

        const ctxPie = document.getElementById('chart-pie').getContext('2d');
        if(chartPieInstance) chartPieInstance.destroy();
        const sortedClients = Object.entries(clientData).sort((a,b) => b[1] - a[1]).slice(0, 5);
        chartPieInstance = new Chart(ctxPie, { type: 'doughnut', data: { labels: sortedClients.map(x => x[0]), datasets: [{ data: sortedClients.map(x => x[1]), backgroundColor: ['#34c759', '#5ac8fa', '#ffcc00', '#ff3b30', '#8e8e93'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    // --- 工具函數 ---
    function openGoalSettings() { document.getElementById('goal-input').value = monthlyGoal; document.getElementById('goal-overlay').classList.remove('hidden'); }
    function saveGoal() { const val = document.getElementById('goal-input').value; if(val) { monthlyGoal = parseInt(val); localStorage.setItem('freelance_goal', monthlyGoal); updateGoalUI(); renderCharts(); document.getElementById('goal-overlay').classList.add('hidden'); } }
    function updateGoalUI() { document.getElementById('goal-target').innerText = '/ $' + parseInt(monthlyGoal).toLocaleString(); }
    function updateGoalProgress(currentIncome) { const percent = Math.min(100, Math.round((currentIncome / monthlyGoal) * 100)); document.getElementById('current-month-income').innerText = '$' + currentIncome.toLocaleString(); document.getElementById('goal-bar').style.width = percent + '%'; document.getElementById('goal-percent').innerText = percent + '%'; const bar = document.getElementById('goal-bar'); if(percent >= 100) bar.style.backgroundColor = '#34c759'; else bar.style.backgroundColor = '#7986cb'; }
    function openAddMode() { currentEditId = null; document.getElementById('form-title').innerText = "新增記錄"; document.getElementById('in-client').value = ''; document.getElementById('in-project').value = ''; document.getElementById('in-amount').value = ''; document.getElementById('in-status').value = '未請款'; document.getElementById('form-overlay').classList.remove('hidden'); }
    function openEditMode(id) { currentEditId = id; const item = rawData.find(r => r.id.toString() === id.toString()); if(!item) return; document.getElementById('form-title').innerText = "編輯記錄"; document.getElementById('in-date').value = item.date.substring(0, 10); document.getElementById('in-client').value = item.client; document.getElementById('in-project').value = item.project; document.getElementById('in-amount').value = item.amount; document.getElementById('in-status').value = item.status; document.getElementById('form-overlay').classList.remove('hidden'); }
    function closeForm() { document.getElementById('form-overlay').classList.add('hidden'); }
    function setDefaultDate() { const offset = new Date().getTimezoneOffset() * 60000; document.getElementById('in-date').value = (new Date(Date.now() - offset)).toISOString().slice(0, 10); }
    function logout() { if(confirm("確定要登出嗎？")) { localStorage.removeItem('freelance_app_password'); location.reload(); } }
    function updateClientDatalist(clients) { const dl = document.getElementById('client-list'); const select = document.getElementById('filter-client'); dl.innerHTML = ''; while (select.options.length > 1) select.remove(1); clients.forEach(c => { if(!c) return; const op1 = document.createElement('option'); op1.value = c; dl.appendChild(op1); const op2 = document.createElement('option'); op2.value = c; op2.text = c; select.add(op2); }); }
    function populateDateFilters() { const yearSelect = document.getElementById('filter-year'); const monthSelect = document.getElementById('filter-month'); if(yearSelect.options.length === 1) { const y = new Date().getFullYear(); for(let i=y; i>=y-5; i--) { const op=document.createElement('option'); op.value=i; op.innerText=i+'年'; yearSelect.appendChild(op); } } if(monthSelect.options.length === 1) { for(let i=1; i<=12; i++) { const op=document.createElement('option'); op.value=i; op.innerText=i+'月'; monthSelect.appendChild(op); } } }
</script>
</body>
</html>
